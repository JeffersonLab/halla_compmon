#!/bin/bash

## Produce makefile to compile CompMon

## Check for configuration file, otherwise use the system default
if [ "x$1" == "x" ];
then
  echo "No configuration file specified, using configs/default.config"
  configfile="configs/default.config"
else
  configfile=$1
fi

## Check that the configuration file exists
if [ -f ${configfile} ];
then
  source ${configfile}
else
  echo "Config file ${configfile} does not exist! Failing."
  exit
fi

## Configure input and output files
template=Makefile.template
makefile=Makefile

## Print makefile header
echo "## DO NOT EDIT THIS FILE BY HAND. USE A CONFIG FILE and run ./config <config_file>" > ${makefile}
echo "## TO AUTO GENERATE THIS MAKEFILE." >> ${makefile}

## Copy over the template to the makefile
cat ${template} >> ${makefile}

## Now replace place holder variables with respective config values
function configVar() {
  ## Make the delimiter the equal sign to avoid conflict with backslashes in paths
  sed -i -e "s=%%config_$1%%=$2=g" -- ${makefile}
}
configVar bindir ${BINDIR}
configVar evio_libpath ${EVIO_LIBPATH}
configVar evio_includepath ${EVIO_LIBPATH}
configVar evio_lib ${EVIO_LIB}

## Last two configurations are the config file used and the current datetime
configVar file ${configfile}
configVar date "`date`"
